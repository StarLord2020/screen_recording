<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Screen Recorder + File System Access API</title>
</head>
<body>
  <button id="start">üé• –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  <button id="stop" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>

  <script>
    let mediaRecorder;
    let writableStream;

    document.getElementById('start').addEventListener('click', async () => {
      try {
        // 1. –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: "recording.webm",
          types: [{
            description: "WebM Video",
            accept: { "video/webm": [".webm"] }
          }]
        });
        writableStream = await fileHandle.createWritable();

        // 2. –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });

        // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MediaRecorder
        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

        mediaRecorder.ondataavailable = async (e) => {
          if (e.data && e.data.size > 0 && writableStream) {
            await writableStream.write(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          if (writableStream) {
            await writableStream.close(); // –ó–∞–∫—Ä—ã—Ç—å —Ñ–∞–π–ª = —Å–¥–µ–ª–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º
            writableStream = null;
          }
          console.log("–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –∑–∞–∫—Ä—ã—Ç ‚úÖ");
        };

        mediaRecorder.start(2000); // –∫–∞–∂–¥—ã–µ 2—Å –æ—Ç–¥–∞—ë—Ç chunk
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞:", err);
      }
    });

    document.getElementById('stop').addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        document.getElementById('start').disabled = false;
        document.getElementById('stop').disabled = true;
      }
    });
  </script>
</body>
</html>
